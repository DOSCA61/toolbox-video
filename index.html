<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Briefing</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .video-container { max-width: 800px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .video-title { color: #333; margin-bottom: 15px; font-size: 24px; }
        #videoWrapper { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; background: #000; }
        #videoWrapper iframe, #videoWrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        #continueBtn { margin-top: 20px; padding: 15px 40px; font-size: 18px; background-color: #ccc; color: #666; border: none; border-radius: 5px; cursor: not-allowed; }
        #continueBtn.ready { background-color: #28a745; color: white; cursor: pointer; }
        #continueBtn.ready:hover { background-color: #218838; }
        #progressContainer { margin-top: 15px; color: #666; }
        #progressBar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        #progressFill { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }
        #status { margin-top: 10px; font-size: 14px; color: #666; }
        #errorMsg { color: #dc3545; margin-top: 20px; padding: 15px; background: #f8d7da; border-radius: 5px; display: none; }
        .gdrive-notice { margin-top: 10px; font-size: 13px; color: #888; }
    </style>
</head>
<body>

<div class="video-container">
    <h2 class="video-title">Safety Briefing - Please Watch Before Signing Off</h2>
    
    <div id="videoWrapper">
        <!-- Video player inserted here by JavaScript -->
    </div>
    
    <div id="progressContainer">
        <div id="progressBar"><div id="progressFill"></div></div>
        <p id="status">Please watch at least 90% of the video to continue</p>
    </div>
    
    <button id="continueBtn" onclick="goToForm()">Continue to Sign-Off</button>
    
    <div id="errorMsg">Error: Could not load video. Please check the link or contact your supervisor.</div>
</div>

<script>
    // Get URL parameters
    var urlParams = new URLSearchParams(window.location.search);
    var videoURL = urlParams.get('video');
    var talkId = urlParams.get('talkid');
    
    // Elements
    var videoWrapper = document.getElementById('videoWrapper');
    var progressFill = document.getElementById('progressFill');
    var progressContainer = document.getElementById('progressContainer');
    var statusText = document.getElementById('status');
    var continueBtn = document.getElementById('continueBtn');
    var errorMsg = document.getElementById('errorMsg');
    
    // Tracking
    var watchedPercent = 0;
    var canProceed = false;
    var requiredPercent = 90;
    
    // Zoho form URL
    var formUrl = 'https://rascortalks.zohocreatorportal.eu/#Report:Your_Toolbox_Talks?ID=' + talkId;
    
    if (videoURL && talkId) {
        
        // Detect video type and extract ID
        var videoId = null;
        var videoType = null;
        
        if (videoURL.includes('youtube.com') || videoURL.includes('youtu.be')) {
            videoType = 'youtube';
            if (videoURL.includes('shorts/')) {
                videoId = videoURL.split('shorts/')[1].split(/[?&]/)[0];
            } else if (videoURL.includes('v=')) {
                videoId = videoURL.split('v=')[1].split(/[?&]/)[0];
            } else if (videoURL.includes('youtu.be/')) {
                videoId = videoURL.split('youtu.be/')[1].split(/[?&]/)[0];
            }
        } else if (videoURL.includes('drive.google.com')) {
            videoType = 'gdrive';
            var match = videoURL.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match) {
                videoId = match[1];
            }
        } else if (videoURL.includes('.mp4') || videoURL.includes('.webm') || videoURL.includes('.ogg')) {
            videoType = 'direct';
            videoId = videoURL;
        }
        
        // Initialize based on video type
        if (videoType === 'youtube' && videoId) {
            initYouTube(videoId);
        } else if (videoType === 'gdrive' && videoId) {
            initGoogleDrive(videoId);
        } else if (videoType === 'direct') {
            initDirectVideo(videoId);
        } else {
            showError('Could not detect video type from URL: ' + videoURL);
        }
        
    } else {
        showError('Missing video URL or talk ID in the link.');
    }
    
    // ========== YouTube Player ==========
    function initYouTube(videoId) {
        var tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        window.onYouTubeIframeAPIReady = function() {
            window.ytPlayer = new YT.Player('videoWrapper', {
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'rel': 0,
                    'modestbranding': 1
                },
                events: {
                    'onReady': onYTReady,
                    'onError': function() { showError('YouTube video failed to load.'); }
                }
            });
        };
    }
    
    function onYTReady(event) {
        event.target.playVideo();
        setInterval(function() {
            if (window.ytPlayer && window.ytPlayer.getDuration) {
                var duration = window.ytPlayer.getDuration();
                var current = window.ytPlayer.getCurrentTime();
                if (duration > 0) {
                    updateProgress((current / duration) * 100);
                }
            }
        }, 1000);
    }
    
    // ========== Google Drive Player ==========
    function initGoogleDrive(fileId) {
        var iframe = document.createElement('iframe');
        iframe.src = 'https://drive.google.com/file/d/' + fileId + '/preview';
        iframe.allow = 'autoplay';
        iframe.id = 'gdrivePlayer';
        videoWrapper.appendChild(iframe);
        
        // Google Drive doesn't expose playback progress via API
        // Use time-based tracking instead
        var notice = document.createElement('p');
        notice.className = 'gdrive-notice';
        notice.textContent = 'Progress is tracked by time. Please watch the full video.';
        progressContainer.appendChild(notice);
        
        // Estimate video duration (default 2 minutes, or pass ?duration= param)
        var estimatedDuration = parseInt(urlParams.get('duration')) || 120;
        var startTime = Date.now();
        
        statusText.textContent = 'Video loaded. Please watch at least 90% (' + Math.round(estimatedDuration * 0.9) + ' seconds)';
        
        setInterval(function() {
            var elapsed = (Date.now() - startTime) / 1000;
            var percent = Math.min((elapsed / estimatedDuration) * 100, 100);
            updateProgress(percent);
        }, 1000);
    }
    
    // ========== Direct MP4/Video Player ==========
    function initDirectVideo(url) {
        var video = document.createElement('video');
        video.src = url;
        video.controls = true;
        video.autoplay = true;
        video.id = 'directPlayer';
        videoWrapper.innerHTML = '';
        videoWrapper.appendChild(video);
        
        video.addEventListener('timeupdate', function() {
            if (video.duration > 0) {
                updateProgress((video.currentTime / video.duration) * 100);
            }
        });
        
        video.addEventListener('error', function() {
            showError('Failed to load video file.');
        });
    }
    
    // ========== Progress Tracking ==========
    function updateProgress(percent) {
        watchedPercent = Math.max(watchedPercent, percent);
        progressFill.style.width = Math.min(watchedPercent, 100) + '%';
        
        if (watchedPercent >= requiredPercent && !canProceed) {
            canProceed = true;
            continueBtn.classList.add('ready');
            continueBtn.style.cursor = 'pointer';
            statusText.textContent = 'âœ“ You can now continue to sign off';
            statusText.style.color = '#28a745';
        } else if (!canProceed) {
            statusText.textContent = 'Watched: ' + Math.round(watchedPercent) + '% (need ' + requiredPercent + '% to continue)';
        }
    }
    
    // ========== Navigation ==========
    function goToForm() {
        if (!canProceed) {
            alert('Please watch at least ' + requiredPercent + '% of the video before continuing.');
            return;
        }
        window.location.href = formUrl;
    }
    
    // ========== Error Handling ==========
    function showError(msg) {
        errorMsg.textContent = 'Error: ' + msg;
        errorMsg.style.display = 'block';
        progressContainer.style.display = 'none';
        continueBtn.style.display = 'none';
    }
</script>

</body>
</html>
