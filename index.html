<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Safety Briefing</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .video-container { max-width: 800px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
    .video-title { color: #333; margin-bottom: 15px; font-size: 24px; }
    #videoWrapper { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; background: #000; }
    #videoWrapper iframe, #videoWrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
    #continueBtn { margin-top: 20px; padding: 15px 40px; font-size: 18px; background-color: #ccc; color: #666; border: none; border-radius: 5px; cursor: not-allowed; }
    #continueBtn.ready { background-color: #28a745; color: white; cursor: pointer; }
    #continueBtn.ready:hover { background-color: #218838; }
    #progressContainer { margin-top: 15px; color: #666; }
    #progressBar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 8px; }
    #progressFill { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }
    #status { margin-top: 10px; font-size: 14px; color: #666; }
    #errorMsg { color: #dc3545; margin-top: 20px; padding: 15px; background: #f8d7da; border-radius: 5px; display: none; }
    #muteNotice { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; cursor: pointer; }
    #muteNotice:hover { background: #ffe69c; }

    .subtitle-overlay {
      position: absolute;
      left: 50%;
      bottom: 6%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 760px;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      font-size: 20px;
      line-height: 1.35;
      text-align: center;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
      pointer-events: none;
      display: none;
      white-space: pre-line;
    }
  </style>
</head>

<body>

<div class="video-container">
  <h2 class="video-title">Safety Briefing - Please Watch Before Signing Off</h2>

  <div id="muteNotice" onclick="unmuteVideo()">ðŸ”‡ Video is muted. Click here to enable sound.</div>

  <div id="videoWrapper">
    <div id="subtitleBox" class="subtitle-overlay"></div>
  </div>

  <div id="progressContainer">
    <div id="progressBar"><div id="progressFill"></div></div>
    <p id="status">Please watch at least 98% of the video to continue</p>
  </div>

  <button id="continueBtn" onclick="goToForm()">Continue to Sign-Off</button>

  <div id="errorMsg"></div>
</div>

<script>
  // ========== URL Parameter Parsing ==========
  function getVideoParam() {
    var search = window.location.search;
    var videoMatch = search.match(/[?&]video=([^&]*youtube[^&]*v[=\/][a-zA-Z0-9_-]+)/i);
    if (videoMatch) {
      var afterVideo = search.substring(search.indexOf(videoMatch[0]) + videoMatch[0].length);
      if (afterVideo.match(/^&(t|list|index|start|end)=/)) {
        var ytParam = afterVideo.match(/^&(t|list|index|start|end)=[^&]*/);
        if (ytParam) return decodeURIComponent(videoMatch[1]) + ytParam[0];
      }
      return decodeURIComponent(videoMatch[1]);
    }
    var urlParams = new URLSearchParams(search);
    return urlParams.get('video');
  }

  function getTalkId() {
    return new URLSearchParams(window.location.search).get('talkid');
  }

  function getSubsParam() {
    return new URLSearchParams(window.location.search).get('srt');
  }

  var videoURL = getVideoParam();
  var talkId = getTalkId();
  var subsURL = getSubsParam();

  var videoWrapper = document.getElementById('videoWrapper');
  var progressFill = document.getElementById('progressFill');
  var statusText = document.getElementById('status');
  var continueBtn = document.getElementById('continueBtn');
  var errorMsg = document.getElementById('errorMsg');
  var subtitleBox = document.getElementById('subtitleBox');
  var muteNotice = document.getElementById('muteNotice');

  // ========== ANTI-SKIP TRACKING ==========
  var secondsWatched = {};
  var videoDuration = 0;
  var canProceed = false;
  var requiredPercent = 98;

  // Store reference to current player for unmute function
  var currentPlayer = null;
  var playerType = null;

  var formUrl = 'https://rascortalks.zohocreatorportal.eu/#Report:Your_Toolbox_Talks?ID=' + talkId;

  // ========== Global Unmute Function ==========
  function unmuteVideo() {
    if (playerType === 'direct' && currentPlayer) {
      currentPlayer.muted = false;
      muteNotice.style.display = 'none';
    } else if (playerType === 'youtube' && currentPlayer && typeof currentPlayer.unMute === 'function') {
      currentPlayer.unMute();
      muteNotice.style.display = 'none';
    }
  }

  // ========== Subtitles ==========
  var SUBS = [];
  var subsReady = false;
  var subIdx = 0;

  function showSubtitle(text) {
    if (!subsReady) return;
    subtitleBox.textContent = text || "";
  }

  function srtTimeToSeconds(t) {
    t = t.trim().replace('.', ',');
    var parts = t.split(/[:,]/);
    if (parts.length < 4) return 0;
    return parseInt(parts[0],10)*3600 + parseInt(parts[1],10)*60 + parseInt(parts[2],10) + parseInt(parts[3],10)/1000;
  }

  function parseSRT(srt) {
    srt = (srt || "").replace(/\r/g,'').trim();
    if (!srt) return [];
    var blocks = srt.split(/\n\n+/);
    var out = [];
    for (var i=0; i<blocks.length; i++) {
      var lines = blocks[i].split('\n').filter(Boolean);
      if (lines.length < 2) continue;
      var timeLine = lines[1].includes('-->') ? lines[1] : lines[0];
      var textStart = lines[1].includes('-->') ? 2 : 1;
      var m = timeLine.match(/(\d\d:\d\d:\d\d[,.]\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d[,.]\d\d\d)/);
      if (!m) continue;
      out.push({ start: srtTimeToSeconds(m[1]), end: srtTimeToSeconds(m[2]), text: lines.slice(textStart).join('\n') });
    }
    return out.sort(function(a,b){ return a.start - b.start; });
  }

  function loadSubtitles(url) {
    if (!url) return;
    fetch(url)
      .then(function(r){ return r.ok ? r.text() : Promise.reject(); })
      .then(function(txt){
        txt = (txt || "").trim();
        if (txt.startsWith("{") || txt.startsWith("[")) {
          SUBS = JSON.parse(txt);
        } else {
          SUBS = parseSRT(txt);
        }
        subsReady = SUBS.length > 0;
        if (subsReady) subtitleBox.style.display = "block";
      })
      .catch(function(){});
  }

  function updateSubtitlesAtTime(t) {
    if (!subsReady) return;
    while (subIdx < SUBS.length && t >= SUBS[subIdx].end) subIdx++;
    while (subIdx > 0 && t < SUBS[subIdx].start) subIdx--;
    var s = SUBS[subIdx];
    showSubtitle(s && t >= s.start && t < s.end ? s.text : "");
  }

  loadSubtitles(subsURL);

  // ========== Progress Tracking (Anti-Skip) ==========
  function markSecondWatched(second) {
    secondsWatched[Math.floor(second)] = true;
  }

  function getUniqueSecondsWatched() {
    return Object.keys(secondsWatched).length;
  }

  function updateProgress() {
    if (videoDuration <= 0) return;
    
    var watched = getUniqueSecondsWatched();
    var percent = (watched / videoDuration) * 100;
    
    progressFill.style.width = Math.min(percent, 100) + '%';

    if (percent >= requiredPercent && !canProceed) {
      canProceed = true;
      continueBtn.classList.add('ready');
      statusText.textContent = 'âœ“ You can now continue to sign off';
      statusText.style.color = '#28a745';
    } else if (!canProceed) {
      statusText.textContent = 'Watched: ' + Math.round(percent) + '% (need ' + requiredPercent + '% to continue)';
    }
  }

  // ========== Video Type Detection ==========
  function extractYouTubeId(url) {
    var patterns = [
      /youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/,
      /youtube\.com\/embed\/([a-zA-Z0-9_-]+)/,
      /youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/,
      /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]+)/,
      /youtu\.be\/([a-zA-Z0-9_-]+)/
    ];
    for (var i = 0; i < patterns.length; i++) {
      var match = url.match(patterns[i]);
      if (match) return match[1];
    }
    return null;
  }

  // ========== YouTube Player ==========
  var ytPlayer = null;
  var ytRetried = false;

  function initYouTube(videoId) {
    var playerDiv = document.createElement('div');
    playerDiv.id = 'ytPlayerDiv';
    videoWrapper.innerHTML = '';
    videoWrapper.appendChild(playerDiv);
    videoWrapper.appendChild(subtitleBox);

    if (window.YT && window.YT.Player) {
      createYTPlayer(videoId);
    } else {
      var tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      document.head.appendChild(tag);
      window.onYouTubeIframeAPIReady = function() { createYTPlayer(videoId); };
    }
  }

  function createYTPlayer(videoId) {
    ytPlayer = new YT.Player('ytPlayerDiv', {
      videoId: videoId,
      playerVars: {
        'autoplay': 1,
        'mute': 0,  // Try with sound first
        'rel': 0,
        'modestbranding': 1,
        'playsinline': 1,
        'disablekb': 1,
        'controls': 1
      },
      events: {
        'onReady': function(e) {
          currentPlayer = ytPlayer;
          playerType = 'youtube';
          videoDuration = e.target.getDuration();
          
          // Try to play with sound
          var playPromise = e.target.playVideo();
          
          // Check after short delay if playing
          setTimeout(function() {
            var state = ytPlayer.getPlayerState();
            // If not playing (state !== 1), mute and retry
            if (state !== 1) {
              ytPlayer.mute();
              ytPlayer.playVideo();
              muteNotice.style.display = 'block';
            }
          }, 1000);
          
          startYTTracking();
        },
        'onStateChange': function(e) {
          // If unstarted or cued and not yet retried, try muted
          if ((e.data === -1 || e.data === 5) && !ytRetried) {
            ytRetried = true;
            ytPlayer.mute();
            ytPlayer.playVideo();
            muteNotice.style.display = 'block';
          }
        },
        'onError': function(e) {
          showError('YouTube error: ' + e.data);
        }
      }
    });
  }

  function startYTTracking() {
    setInterval(function() {
      if (ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
        var current = ytPlayer.getCurrentTime();
        var state = ytPlayer.getPlayerState();
        
        if (state === 1) {
          markSecondWatched(current);
        }
        
        updateProgress();
        updateSubtitlesAtTime(current);
      }
    }, 250);
  }

  // ========== Direct MP4 Player ==========
  function initDirectVideo(url) {
    var video = document.createElement('video');
    video.src = url;
    video.controls = true;
    video.playsInline = true;
    video.id = 'directPlayer';
    
    videoWrapper.innerHTML = '';
    videoWrapper.appendChild(video);
    videoWrapper.appendChild(subtitleBox);

    currentPlayer = video;
    playerType = 'direct';

    video.addEventListener('loadedmetadata', function() {
      videoDuration = video.duration;
    });

    // Try autoplay WITH sound first
    video.muted = false;
    var playPromise = video.play();
    
    if (playPromise !== undefined) {
      playPromise.then(function() {
        // Success - playing with sound
        muteNotice.style.display = 'none';
      }).catch(function() {
        // Blocked - retry muted
        video.muted = true;
        video.play();
        muteNotice.style.display = 'block';
      });
    }

    // Track only while playing
    var lastTime = 0;
    video.addEventListener('timeupdate', function() {
      var current = video.currentTime;
      
      if (Math.abs(current - lastTime) < 2) {
        markSecondWatched(current);
      }
      lastTime = current;
      
      updateProgress();
      updateSubtitlesAtTime(current);
    });

    video.addEventListener('seeking', function() {
      lastTime = video.currentTime;
    });

    video.addEventListener('error', function() {
      showError('Failed to load video file.');
    });
  }

  // ========== Google Drive ==========
  function initGoogleDrive(fileId) {
    var iframe = document.createElement('iframe');
    iframe.src = 'https://drive.google.com/file/d/' + fileId + '/preview';
    iframe.allow = 'autoplay';
    videoWrapper.innerHTML = '';
    videoWrapper.appendChild(iframe);
    videoWrapper.appendChild(subtitleBox);

    playerType = 'gdrive';

    var urlParams = new URLSearchParams(window.location.search);
    var estimatedDuration = parseInt(urlParams.get('duration')) || 120;
    videoDuration = estimatedDuration;
    var startTime = Date.now();

    statusText.textContent = 'Please watch the full video (' + Math.round(estimatedDuration * 0.9) + ' seconds minimum)';

    setInterval(function() {
      var elapsed = (Date.now() - startTime) / 1000;
      markSecondWatched(elapsed);
      updateProgress();
      updateSubtitlesAtTime(elapsed);
    }, 1000);
  }

  // ========== Init ==========
  if (videoURL && talkId) {
    var videoId = null;
    var videoType = null;

    if (videoURL.includes('youtube.com') || videoURL.includes('youtu.be')) {
      videoType = 'youtube';
      videoId = extractYouTubeId(videoURL);
    } else if (videoURL.includes('drive.google.com')) {
      videoType = 'gdrive';
      var match = videoURL.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match) videoId = match[1];
    } else if (videoURL.match(/\.(mp4|webm|ogg)/i)) {
      videoType = 'direct';
      videoId = videoURL;
    }

    if (videoType === 'youtube' && videoId) initYouTube(videoId);
    else if (videoType === 'gdrive' && videoId) initGoogleDrive(videoId);
    else if (videoType === 'direct') initDirectVideo(videoId);
    else showError('Could not detect video type');
  } else {
    showError('Missing video URL or talk ID');
  }

  function goToForm() {
    if (!canProceed) {
      alert('Please watch at least ' + requiredPercent + '% of the video before continuing.');
      return;
    }
    window.location.href = formUrl;
  }

  function showError(msg) {
    errorMsg.textContent = 'Error: ' + msg;
    errorMsg.style.display = 'block';
    document.getElementById('progressContainer').style.display = 'none';
    continueBtn.style.display = 'none';
    subtitleBox.style.display = 'none';
  }
</script>

</body>
</html>
